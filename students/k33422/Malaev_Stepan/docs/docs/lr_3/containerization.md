# Контейнеризация приложения

Контейнеризация — это процесс упаковки приложения и всех его зависимостей в единый контейнер, который можно запустить на любой
платформе, поддерживающей Docker. Это упрощает процесс развертывания, позволяет обеспечить консистентность среды выполнения и
улучшает масштабируемость. В данном случае контейнеризация приложения осуществляется с помощью **Docker Compose**, которое
включает PostgreSQL, Redis, FastAPI приложение, а также worker для асинхронных задач.

---

## Архитектура приложения

Приложение состоит из нескольких сервисов:

1. **PostgreSQL** — база данных.
2. **Redis** — брокер сообщений для очередей задач.
3. **App** — FastAPI приложение.
4. **Worker** — асинхронный воркер, который обрабатывает задачи с использованием Taskiq.

Каждый из этих сервисов работает в отдельном контейнере, а их взаимодействие происходит через внутреннюю сеть, настроенную с
помощью Docker Compose.

---

## Конфигурация Docker Compose

### 1. **Сервис PostgreSQL**

PostgreSQL — это база данных, которая используется для хранения информации приложения.

- **Образ**: `huecker.io/library/postgres:16-alpine` — легковесный образ PostgreSQL на базе Alpine Linux.
- **Переменные окружения**: Задаются через `.env` файл для передачи конфиденциальной информации, такой как пользователь, пароль
  и база данных.
    - `POSTGRES_USER` — имя пользователя базы данных.
    - `POSTGRES_PASSWORD` — пароль для доступа к базе данных.
    - `POSTGRES_DB` — имя базы данных.
- **Healthcheck**: Определяет, когда контейнер готов к работе, проверяя соединение с базой данных с помощью
  команды `pg_isready`.
- **Тома**: Данные PostgreSQL сохраняются в постоянное хранилище с использованием тома `pgdata`, чтобы данные не терялись при
  перезапуске контейнера.
- **Порты**: Контейнер слушает порт `5432`, который проксируется наружу.

### 2. **Сервис Redis**

Redis используется как брокер сообщений для очередей задач. В данном случае он взаимодействует с Celery для фоновых задач.

- **Образ**: `huecker.io/library/redis:7-alpine` — легковесный образ Redis.
- **Переменные окружения**: Настраиваются через `.env` файл.
    - `RD_PASSWORD` — пароль для доступа к Redis, обеспечивающий безопасность сервиса.
- **Healthcheck**: Проверка состояния Redis с помощью команды `redis-cli` и пароля.
- **Порты**: Контейнер Redis прослушивает стандартный порт `6379`, который также проксируется наружу.

### 3. **Сервис App (FastAPI)**

Основное приложение на FastAPI, которое обрабатывает запросы и взаимодействует с базой данных и Redis.

- **Сборка**: Сервис собирается из проекта на основе Dockerfile.
- **Переменные окружения**: Задаются через общий блок переменных окружения `<<: *routes`, который включает такие параметры как:
    - `PG_HOST`, `PG_PORT` — параметры для подключения к базе данных.
    - `RD_HOST`, `RD_PORT` — параметры для подключения к Redis.
    - `AP_HOST`, `AP_PORT` — параметры для работы самого приложения.
- **Команда**: Запуск приложения осуществляется с помощью команды `uvicorn`, которая запускает FastAPI на порту `3030`.
- **Зависимости**: Сервис зависит от состояния `Postgres` и `Redis`, которые должны быть готовы для работы (в
  состоянии `healthy`), прежде чем приложение сможет запуститься.

### 4. **Сервис Worker**

Worker выполняет асинхронные задачи, используя Taskiq и взаимодействуя с Redis как брокером сообщений.

- **Сборка**: Сервис также собирается на основе проекта с использованием того же Dockerfile, что и для `app`.
- **Переменные окружения**: Использует общий блок переменных окружения `<<: *routes`.
- **Команда**: Запускает воркер с помощью Taskiq для обработки задач из очередей.
- **Зависимости**: Сервис зависит не только от `Postgres` и `Redis`, но также от самого приложения `App`, которое должно быть
  запущено.

### Тома (Volumes)

- **pgdata**: Используется для сохранения данных PostgreSQL, чтобы обеспечить их сохранность при перезапуске контейнеров.

---

## Dockerfile

**Dockerfile** описывает, как собирать приложение внутри контейнера. Вот ключевые моменты:

1. **Базовый образ**: Используется легковесный образ Python `huecker.io/library/python:3.11-slim`.

2. **Рабочая директория**: `WORKDIR /app` — все операции выполняются внутри директории `/app` в контейнере.

3. **Установка зависимостей**:
    - Устанавливается `uv` для создания виртуального окружения.
    - Виртуальное окружение размещается в директории `/opt/venv`.
    - Устанавливаются зависимости из файла `pyproject.toml` с помощью poetry.

4. **Копирование исходных файлов**:
    - Исходные файлы приложения (директория `src`), миграции (директория `migrations`), ключи и конфигурационный
      файл `alembic.ini` копируются в контейнер.

5. **Запуск**: Команда для запуска контейнера определяется в сервисах `app` и `worker` через Docker Compose.

---
