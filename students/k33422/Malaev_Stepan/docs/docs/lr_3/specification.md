# Лабораторная работа 3: Упаковка FastAPI приложения в Docker, работа с источниками данных и очередями

## Цель

Научиться упаковывать FastAPI приложение в Docker, интегрировать парсер данных с базой данных и вызывать парсер через API и
очередь задач.

## Оценка выполнения

- **Задачи 1 и 2** — минимальные задачи для сдачи работы и получения 70% баллов.
- **Задачи 1, 2 и 3** — выполнение всех задач для получения 100% баллов.

---

## Подзадача 1: Упаковка FastAPI приложения, базы данных и парсера данных в Docker

### Описание

**Docker** — это платформа для создания контейнеров, которые упрощают разработку, развертывание и запуск приложений. Контейнеры
позволяют упаковать приложение и все его зависимости в единый образ, который можно запустить на любой системе, поддерживающей
Docker. Это обеспечивает консистентность среды выполнения, повышает гибкость и масштабируемость приложений.

### Шаги выполнения:

1. **Создание FastAPI приложения**:
    - Приложение создано в рамках лабораторной работы №1.

2. **Создание базы данных**:
    - База данных также создана в лабораторной работе №1.

3. **Создание парсера данных**:
    - Парсер данных был разработан в лабораторной работе №2.

4. **Реализация вызова парсера по HTTP**:
    - Создайте FastAPI эндпоинт для вызова парсера. Это может быть отдельное приложение или модуль в существующем FastAPI
      приложении.

Пример кода вызова парсера через HTTP:

```python
from fastapi import FastAPI, HTTPException
import requests

app = FastAPI()


@app.post("/parse")
def parse(url: str):
    try:
        response = requests.get(url)
        response.raise_for_status()
        # Вызов парсера
        return {"message": "Parsing completed", ...}
    except requests.RequestException as e:
        raise HTTPException(status_code=500, detail=str(e))
```

### Разработка Dockerfile

Необходимо создать **Dockerfile** для FastAPI приложения и приложения с парсером данных. В Dockerfile должны быть указаны:

- Базовый образ (например, `python:3.9`),
- Установка всех необходимых зависимостей,
- Копирование исходных файлов в контейнер,
- Определение команды для запуска приложения.

**Зачем**: Docker позволяет упаковать приложение и его зависимости в единый контейнер, обеспечивая консистентность среды
выполнения и упрощая развертывание.

**Полезные ссылки**:

- [FastAPI и Docker](https://fastapi.tiangolo.com/deployment/docker/)
- [Запуск PostgreSQL в Docker](https://habr.com/ru/post/564284/)
- [Документация Dockerfile](https://docs.docker.com/engine/reference/builder/)

### Создание Docker Compose файла

Напишите `docker-compose.yml` для управления оркестром сервисов, включающим FastAPI приложение, базу данных и парсер данных.
Определите необходимые сервисы, укажите порты и зависимости между ними.

**Зачем**: Docker Compose позволяет легко управлять несколькими контейнерами, упрощая запуск и настройку всех сервисов с
помощью одного файла конфигурации.

**Полезные ссылки**:

- [Зачем нужны системы оркестрации?](https://tproger.ru/articles/orchestraciya-mikroservisov-ili-kak-upravlyat-armiej-kontejnerov/)
- [FastAPI в Docker](https://fastapi.tiangolo.com/deployment/docker/)
- [Документация Docker Compose](https://docs.docker.com/compose/)

---

## Подзадача 2: Вызов парсера из FastAPI

### Описание

Добавьте в FastAPI приложение эндпоинт, который будет принимать URL от клиента для парсинга, передавать его парсеру (который
запущен в отдельном контейнере) и возвращать результат клиенту.

**Зачем**: Это позволит интегрировать функциональность парсера в веб-приложение и дать пользователям возможность вызывать
парсинг данных через API.

**Полезные ссылки**:

- [Документация FastAPI](https://fastapi.tiangolo.com/)

---

## Подзадача 3: Вызов парсера из FastAPI через очередь (Celery и Redis)

### Как это работает

1. **Celery и Redis**:
    - **Celery** — это асинхронная система очередей задач, которая позволяет распределять и выполнять задачи в фоне.
    - **Redis** используется как брокер сообщений, который хранит задачи для выполнения. При получении HTTP-запроса задача
      ставится в очередь Redis, и Celery-воркер обрабатывает её в фоне.

2. **Docker Compose**:
    - Настройте Docker Compose для запуска Celery, Redis и FastAPI в отдельных контейнерах, которые работают в одной сети. Это
      упрощает управление зависимостями и конфигурацией всех компонентов системы.

**Зачем**: Очередь задач с использованием Celery и Redis позволяет выполнять долгие задачи в фоне, не блокируя основной поток
FastAPI приложения, что повышает масштабируемость и производительность системы.

**Полезные ссылки**:

- [Документация Celery](https://docs.celeryproject.org/en/stable/getting-started/introduction.html)
- [Документация Redis](https://redis.io/documentation)
- [FastAPI с Celery и Redis](https://testdriven.io/blog/fastapi-celery/)

---

## Полезные материалы

- [Основы работы с Docker](https://tproger.ru/translations/docker-for-beginners/)
- [FastAPI и Docker](https://fastapi.tiangolo.com/deployment/docker/)
- [Docker Compose и многоконтейнерные приложения](https://docs.docker.com/compose/)

---
